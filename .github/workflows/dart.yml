name: Flutter Build IPA

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.5'
        channel: stable

    - name: Install dependencies
      run: flutter pub get

    # âœ… Patch Podfile untuk iOS 13.0 (1x saja)
    - name: Set iOS Deployment Target to 13.0
      run: |
        if grep -q "platform :ios" ios/Podfile; then
          sed -i '' "s/platform :ios, .*/platform :ios, '13.0'/" ios/Podfile
        else
          sed -i '' '1s/^/platform :ios, '\''13.0'\''\n/' ios/Podfile
        fi

    - name: Install CocoaPods dependencies
      run: |
        cd ios
        pod install
        cd ..

    - name: Build IPA (unsigned)
      run: flutter build ipa --no-codesign

    - name: Upload IPA Artifact
      uses: actions/upload-artifact@v4
      with:
        name: app-release.ipa
        path: build/ios/ipa/*.ipa
